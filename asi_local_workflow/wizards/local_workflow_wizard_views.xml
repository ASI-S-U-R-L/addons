<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Vista del wizard principal -->
    <record id="view_local_workflow_wizard_form" model="ir.ui.view">
        <field name="name">local.workflow.wizard.form</field>
        <field name="model">local.workflow.wizard</field>
        <field name="arch" type="xml">
            <form string="Iniciar Solicitud de Firma">
                <sheet>

                    <div class="alert alert-info" role="alert">
                        <h4><i class="fa fa-cogs" /> Configuración de la Solicitud de Firma</h4>
                        <p>Configure los parámetros básicos para la solicitud de firma digital
                            con hasta 4 destinatarios.</p>
                    </div>

                    <group>
                        <group>
                            <field name="name" />
                        </group>
                    </group>

                    <!-- Configuración de Firma -->
                    <group string="Configuración de Firma" col="2">
                        <group>
                            <field name="signature_opaque_background" />
                        </group>
                        <group>
                            <field name="sign_all_pages" />
                        </group>
                    </group>

                    <!-- Destinatario 1 (siempre visible) -->
                    <group string="Destinatario 1" col="2">
                        <group>
                            <field name="target_user_id_1" options="{'no_create': True}"
                                required="1" />
                            <field name="signature_role_id_1" options="{'no_create': True}"
                                required="1" />
                        </group>
                        <group>
                            <field name="signature_position_1" required="1" />
                        </group>
                    </group>

                    <!-- Destinatario 2 (visible solo si destinatario 1 está completo) -->
                    <group string="Destinatario 2 (Opcional)" col="2"
                        attrs="{'invisible': ['|', '|', ('target_user_id_1', '=', False), ('signature_role_id_1', '=', False), ('signature_position_1', '=', False)]}">
                        <group>
                            <field name="target_user_id_2" options="{'no_create': True}" />
                            <field name="signature_role_id_2" options="{'no_create': True}"
                                attrs="{'required': [('target_user_id_2', '!=', False)]}" />
                        </group>
                        <group>
                            <field name="signature_position_2"
                                attrs="{'required': [('target_user_id_2', '!=', False)]}" />
                        </group>
                    </group>

                    <!-- Destinatario 3 (visible solo si destinatario 2 está completo) -->
                    <group string="Destinatario 3 (Opcional)" col="2"
                        attrs="{'invisible': ['|', '|', ('target_user_id_2', '=', False), ('signature_role_id_2', '=', False), ('signature_position_2', '=', False)]}">
                        <group>
                            <field name="target_user_id_3" options="{'no_create': True}" />
                            <field name="signature_role_id_3" options="{'no_create': True}"
                                attrs="{'required': [('target_user_id_3', '!=', False)]}" />
                        </group>
                        <group>
                            <field name="signature_position_3"
                                attrs="{'required': [('target_user_id_3', '!=', False)]}" />
                        </group>
                    </group>

                    <!-- Destinatario 4 (visible solo si destinatario 3 está completo) -->
                    <group string="Destinatario 4 (Opcional)" col="2"
                        attrs="{'invisible': ['|', '|', ('target_user_id_3', '=', False), ('signature_role_id_3', '=', False), ('signature_position_3', '=', False)]}">
                        <group>
                            <field name="target_user_id_4" options="{'no_create': True}" />
                            <field name="signature_role_id_4" options="{'no_create': True}"
                                attrs="{'required': [('target_user_id_4', '!=', False)]}" />
                        </group>
                        <group>
                            <field name="signature_position_4"
                                attrs="{'required': [('target_user_id_4', '!=', False)]}" />
                        </group>
                    </group>

                    <!-- Información de los usuarios destinatarios -->
                    <div attrs="{'invisible': [('target_user_id_1', '=', False)]}">
                        <field name="target_user_info" nolabel="1" />
                    </div>

                    <!-- Documentos -->
                    <group string="Documentos a Firmar" col="1">
                        <field name="document_ids" nolabel="1">
                            <tree string="Documentos" editable="bottom">
                                <field name="name" />
                                <field name="pdf_content" filename="pdf_filename" />
                                <field name="pdf_filename" invisible="1" />
                                <field name="file_size" />
                            </tree>
                        </field>
                    </group>

                    <!-- Notas -->
                    <group string="Notas" col="1">
                        <field name="notes" nolabel="1"
                            placeholder="Notas adicionales sobre la solicitud..." />
                    </group>
                </sheet>

                <footer>
                    <button string="Crear Solicitud" name="action_create_workflow" type="object"
                        class="btn-primary" />
                    <button string="Cancelar" class="btn-secondary" special="cancel" />
                </footer>
            </form>
        </field>
    </record>

    <!-- Acción para abrir el wizard -->
    <record id="action_local_workflow_wizard" model="ir.actions.act_window">
        <field name="name">Iniciar Solicitud de Firma</field>
        <field name="res_model">local.workflow.wizard</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
    </record>
</odoo>