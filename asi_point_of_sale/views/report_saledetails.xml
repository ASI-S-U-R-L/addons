<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="report_saledetails_extended" inherit_id="point_of_sale.report_saledetails">

        <!-- Agregar logo de la compañía en el encabezado derecho (versión corregida) -->
        <xpath expr="//div[hasclass('page')]" position="before">
            <div class="row" style="position: absolute; top: 0; right: 0; padding: 10px; margin-right: 31px;">
                <img t-att-src="company.logo and image_data_uri(company.logo) or ''" 
                     t-if="company.logo" 
                     style="max-height: 100px; max-width: 300px;"/>
                <div t-if="not company.logo" style="font-size: 10px; color: #999;">
                    No logo available
                </div>
            </div>
        </xpath>
        
        <!-- Ajustar margen superior para evitar solapamiento con el logo -->
        <xpath expr="//div[hasclass('text-center')]" position="attributes">
            <attribute name="style">margin-top: 0px;</attribute>
        </xpath>

        <xpath expr="//table[1]/thead/tr" position="replace">
            <tr style="border: 1px solid #ddd;">
                <th class="text-center" style="border: 1px solid #ddd;">Producto</th>
                <th class="text-center" style="border: 1px solid #ddd;">Cantidad</th>
                <th class="text-center" style="border: 1px solid #ddd;">Precio</th>
                <th class="text-center" style="border: 1px solid #ddd;">Precio x Cantidad</th>
                <th class="text-center" style="border: 1px solid #ddd;">Coste</th>
                <th class="text-center" style="border: 1px solid #ddd;">Coste x Cantidad</th>
                <th class="text-center" style="border: 1px solid #ddd;">Ganancia</th>
            </tr>
        </xpath>
        
        <xpath expr="//table[1]/tbody/tr" position="replace">
            <tr t-foreach="products" t-as="line" style="border: 1px solid #ddd;">
                <td style="border: 1px solid #ddd;"><t t-esc="line['product_name']" /></td>
                <td class="text-center" style="border: 1px solid #ddd;">
                    <t t-esc="line['quantity']" />
                    <t t-if="line['uom'] != 'Units'">
                        <t t-esc="line['uom']" />
                    </t>
                </td>
                <td class="text-right text-end" style="border:1px solid #ddd; text-align:right;">
                    <t t-if="currency">
                        <t t-esc="line['price_unit']" t-options="{'widget': 'monetary', 'display_currency': currency}"/>
                    </t>
                    <t t-else="">
                        <t t-esc="line['price_unit']"/>
                    </t>
                </td>
                <td class="text-right text-end" style="border:1px solid #ddd; text-align:right;">
                    <t t-if="currency">
                        <t t-esc="line['price_quantity']" t-options="{'widget': 'monetary', 'display_currency': currency}"/>
                    </t>
                    <t t-else="">
                        <t t-esc="line['price_quantity']"/>
                    </t>
                </td>
                <td class="text-right text-end" style="border:1px solid #ddd; text-align:right;">
                    <t t-if="currency">
                        <t t-esc="line['cost']" t-options="{'widget': 'monetary', 'display_currency': currency}"/>
                    </t>
                    <t t-else="">
                        <t t-esc="line['cost']"/>
                    </t>
                </td>
                <td class="text-right text-end" style="border:1px solid #ddd; text-align:right;">
                    <t t-if="currency">
                        <t t-esc="line['cost_subtotal']" t-options="{'widget': 'monetary', 'display_currency': currency}"/>
                    </t>
                    <t t-else="">
                        <t t-esc="line['cost_subtotal']"/>
                    </t>
                </td>
                <td class="text-right text-end" style="border:1px solid #ddd; text-align:right;">
                    <t t-if="currency">
                        <t t-esc="line['profit_with_tax']" t-options="{'widget': 'monetary', 'display_currency': currency}"/>
                    </t>
                    <t t-else="">
                        <t t-esc="line['profit_with_tax']"/>
                    </t>
                </td>
            </tr>
        </xpath>
        
        <xpath expr="//h3[contains(text(), 'Payments') or contains(text(), 'Pagos')]" position="replace">
            <h3>Ventas</h3>
        </xpath>

        <xpath expr="//strong[contains(text(), 'Total:')]" position="replace"></xpath>

        <!-- Modificar el total al final del reporte para incluir coste total y ganancia total en paralelo -->
        <xpath expr="//table[1]/tbody/tr" position="after">
            <table class="table table-sm mt-4" style="margin-top: 35px; width: 100%; border-collapse: separate; border-spacing: 10px 0;">
                <tr>
                    <td style="width: 33%; text-align: center;">
                        <strong>Venta Total:</strong>
                        <br/>
                        <strong><t t-esc="total_paid" t-options="{'widget': 'float', 'precision': currency_precision}"/></strong>
                    </td>
                    <td style="width: 33%; text-align: center;">
                        <strong>Coste Total:</strong>
                        <br/>
                        <strong>
                            <t t-if="currency">
                                <t t-esc="total_cost_subtotal" t-options="{'widget': 'monetary', 'display_currency': currency}"/>
                            </t>
                            <t t-else="">
                                <t t-esc="total_cost_subtotal"/>
                            </t>
                        </strong>
                    </td>
                    <td style="width: 33%; text-align: center;">
                        <strong>Ganancia Total:</strong>
                        <br/>
                        <strong>
                            <t t-if="currency">
                                <t t-esc="total_profit_with_tax" t-options="{'widget': 'monetary', 'display_currency': currency}"/>
                            </t>
                            <t t-else="">
                                <t t-esc="total_profit_with_tax"/>
                            </t>
                        </strong>
                    </td>
                </tr>
            </table>
        </xpath>
    </template>
</odoo>
