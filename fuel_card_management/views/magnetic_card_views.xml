<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Vista de formulario para tarjetas magnéticas -->
    <record id="view_fuel_magnetic_card_form" model="ir.ui.view">
        <field name="name">fuel.magnetic.card.form</field>
        <field name="model">fuel.magnetic.card</field>
        <field name="arch" type="xml">
            <form string="Tarjeta Magnética de Combustible">
                <header>
                    <button name="action_activate" type="object" string="Activar" 
                            class="oe_highlight" states="draft"/>
                    <button name="action_block" type="object" string="Bloquear" 
                            states="available,assigned"/>
                    <button name="action_unblock" type="object" string="Desbloquear" 
                            states="blocked"/>
                    <button name="action_cancel" type="object" string="Cancelar" 
                            states="available,assigned,blocked"/>
                    <button name="action_reset_to_draft" type="object" string="Reiniciar" 
                            states="cancelled"/>
                    <field name="operational_state" widget="statusbar" 
                           statusbar_visible="draft,available,assigned,blocked,expired,cancelled"/>
                </header>
                <sheet>
                    <div class="oe_title">
                        <h1>
                            <field name="name" placeholder="Número de 16 dígitos"/>
                        </h1>
                    </div>
                    <group>
                        <group>
                            <field name="card_type"/>
                            <field name="carrier_ids" widget="many2many_tags" 
                                   options="{'no_create_edit': True}"
                                   string="Portadores de Combustible"/>
                            <field name="issue_date"/>
                            <field name="expiry_date"/>
                            <field name="pin" groups="fuel_card_management.group_fuel_card_manager"/>
                        </group>
                        <group>
                            <field name="vehicle_id" attrs="{
                                'invisible': [('operational_state', '=', 'draft')],
                                'readonly': [('operational_state', '!=', 'draft')]
                            }"/>
                            <field name="vehicle_custom_type" invisible="1"/>
                            <field name="engine_type" attrs="{
                                'invisible': ['|', ('vehicle_custom_type', '!=', 'tecnologico'), ('operational_state', '=', 'draft')],
                                'required': [('vehicle_custom_type', '=', 'tecnologico'), ('operational_state', '=', 'assigned')],
                                'readonly': [('operational_state', '!=', 'draft')]
                            }"/>
                            <field name="driver_id" attrs="{
                                'invisible': [('operational_state', '=', 'draft')],
                                'readonly': [('operational_state', '!=', 'draft')]
                            }"/>
                            <field name="is_delivered" attrs="{
                                'invisible': [('operational_state', '=', 'draft')],
                                'readonly': [('operational_state', '!=', 'draft')]
                            }"/>
                        </group>
                    </group>
                    
                    <!-- Información de saldo (oculta en draft) -->
                    <group string="Información de Saldo" attrs="{'invisible': [('operational_state', '=', 'draft')]}">
                        <group>
                            <field name="current_balance" widget="monetary"/>
                        </group>
                        <group>
                            <field name="state" invisible="1"/>
                            <field name="active" string="Activa" attrs="{'invisible': [('operational_state', '=', 'draft')]}"/>
                        </group>
                    </group>
                    
                    <notebook>
                        <page string="Registros de Combustible" attrs="{'invisible': [('operational_state', '=', 'draft')]}">
                            <field name="fuel_log_ids" readonly="1">
                                <tree>
                                    <field name="date"/>
                                    <field name="vehicle_id"/>
                                    <field name="liter"/>
                                    <field name="price_per_liter"/>
                                    <field name="amount"/>
                                    <field name="state"/>
                                </tree>
                            </field>
                        </page>
                        <page string="Notas">
                            <field name="notes" nolabel="1"/>
                        </page>
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids" widget="mail_followers"/>
                    <field name="activity_ids" widget="mail_activity"/>
                    <field name="message_ids" widget="mail_thread"/>
                </div>
            </form>
        </field>
    </record>

    <!-- Vista de lista para tarjetas magnéticas -->
    <record id="view_fuel_magnetic_card_tree" model="ir.ui.view">
        <field name="name">fuel.magnetic.card.tree</field>
        <field name="model">fuel.magnetic.card</field>
        <field name="arch" type="xml">
            <tree string="Tarjetas Magnéticas" decoration-success="operational_state=='available'" 
                  decoration-info="operational_state=='assigned'" decoration-muted="operational_state=='cancelled'"
                  decoration-warning="operational_state=='blocked'" decoration-danger="operational_state=='expired'">
                <field name="name"/>
                <field name="card_type"/>
                <field name="carrier_ids" widget="many2many_tags" string="Portadores"/>
                <field name="vehicle_id"/>
                <field name="vehicle_custom_type"/>
                <field name="engine_type" attrs="{'invisible': [('vehicle_custom_type', '!=', 'tecnologico')]}"/>
                <field name="driver_id"/>
                <field name="current_balance" widget="monetary"/>
                <field name="expiry_date"/>
                <field name="operational_state" widget="badge" 
                       decoration-success="operational_state=='available'" 
                       decoration-info="operational_state=='assigned'"
                       decoration-warning="operational_state=='blocked'"
                       decoration-danger="operational_state=='expired'"
                       decoration-muted="operational_state=='cancelled'"/>
            </tree>
        </field>
    </record>

    <!-- Vista kanban para tarjetas magnéticas -->
    <record id="view_fuel_magnetic_card_kanban" model="ir.ui.view">
        <field name="name">fuel.magnetic.card.kanban</field>
        <field name="model">fuel.magnetic.card</field>
        <field name="arch" type="xml">
            <kanban class="o_kanban_mobile">
                <field name="name"/>
                <field name="card_type"/>
                <field name="carrier_ids"/>
                <field name="vehicle_id"/>
                <field name="vehicle_custom_type"/>
                <field name="engine_type"/>
                <field name="driver_id"/>
                <field name="current_balance"/>
                <field name="operational_state"/>
                <field name="expiry_date"/>
                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_card oe_kanban_global_click">
                            <div class="o_kanban_record_top">
                                <div class="o_kanban_record_headings">
                                    <strong class="o_kanban_record_title">
                                        <field name="name"/>
                                    </strong>
                                </div>
                                <span class="float-right badge badge-pill" 
                                      t-attf-class="badge-#{record.operational_state.raw_value == 'available' ? 'success' : record.operational_state.raw_value == 'assigned' ? 'info' : record.operational_state.raw_value == 'blocked' ? 'warning' : record.operational_state.raw_value == 'expired' ? 'danger' : 'secondary'}">
                                    <field name="operational_state"/>
                                </span>
                            </div>
                            <div class="o_kanban_record_body">
                                <div>
                                    <i class="fa fa-tag"/> <field name="card_type"/>
                                </div>
                                <div t-if="record.carrier_ids.raw_value.length > 0">
                                    <i class="fa fa-tint"/> 
                                    <field name="carrier_ids" widget="many2many_tags"/>
                                </div>
                                <div t-if="record.vehicle_id.raw_value">
                                    <i class="fa fa-car"/> <field name="vehicle_id"/>
                                    <t t-if="record.vehicle_custom_type.raw_value == 'tecnologico' and record.engine_type.raw_value">
                                        (<field name="engine_type"/>)
                                    </t>
                                </div>
                                <div t-if="record.driver_id.raw_value">
                                    <i class="fa fa-user"/> <field name="driver_id"/>
                                </div>
                                <div>
                                    <i class="fa fa-money"/> Saldo: <field name="current_balance" widget="monetary"/>
                                </div>
                                <div>
                                    <i class="fa fa-calendar"/> Vence: <field name="expiry_date"/>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- Vista de búsqueda -->
    <record id="view_fuel_magnetic_card_search" model="ir.ui.view">
        <field name="name">fuel.magnetic.card.search</field>
        <field name="model">fuel.magnetic.card</field>
        <field name="arch" type="xml">
            <search string="Buscar Tarjetas Magnéticas">
                <field name="name"/>
                <field name="vehicle_id"/>
                <field name="driver_id"/>
                <field name="carrier_ids" string="Portadores"/>
                <separator/>
                <filter name="filter_available" string="Disponibles" domain="[('operational_state', '=', 'available')]"/>
                <filter name="filter_assigned" string="Asignadas" domain="[('operational_state', '=', 'assigned')]"/>
                <filter name="filter_blocked" string="Bloqueadas" domain="[('operational_state', '=', 'blocked')]"/>
                <filter name="filter_expired" string="Vencidas" domain="[('operational_state', '=', 'expired')]"/>
                <separator/>
                <filter name="filter_basica" string="Básicas" domain="[('card_type', '=', 'basica')]"/>
                <filter name="filter_reserva" string="Reserva" domain="[('card_type', '=', 'reserva')]"/>
                <separator/>
                <filter name="filter_tecnologico" string="Vehículos Tecnológicos" domain="[('vehicle_custom_type', '=', 'tecnologico')]"/>
                <filter name="filter_movil" string="Vehículos Móviles" domain="[('vehicle_custom_type', '=', 'movil')]"/>
                <filter name="filter_estacionario" string="Vehículos Estacionarios" domain="[('vehicle_custom_type', '=', 'estacionario')]"/>
                <separator/>
                <filter name="filter_low_balance" string="Saldo Bajo" domain="[('current_balance', '&lt;', 100)]"/>
                <filter name="filter_expiring_soon" string="Vencen Pronto" 
                        domain="[('expiry_date', '&lt;=', (context_today() + datetime.timedelta(days=30)).strftime('%Y-%m-%d'))]"/>
                <group expand="0" string="Agrupar por">
                    <filter name="group_operational_state" string="Estado Operativo" context="{'group_by': 'operational_state'}"/>
                    <filter name="group_card_type" string="Tipo de Tarjeta" context="{'group_by': 'card_type'}"/>
                    <filter name="group_vehicle_type" string="Tipo de Vehículo" context="{'group_by': 'vehicle_custom_type'}"/>
                    <filter name="group_carrier" string="Portador" context="{'group_by': 'carrier_ids'}"/>
                    <filter name="group_vehicle" string="Vehículo" context="{'group_by': 'vehicle_id'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Acción para tarjetas magnéticas -->
    <record id="action_fuel_magnetic_card" model="ir.actions.act_window">
        <field name="name">Tarjetas Magnéticas</field>
        <field name="res_model">fuel.magnetic.card</field>
        <field name="view_mode">tree,kanban,form</field>
        <field name="search_view_id" ref="view_fuel_magnetic_card_search"/>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                ¡Crea tu primera tarjeta magnética!
            </p>
            <p>
                Gestiona las tarjetas magnéticas de combustible. 
                Puedes asignar múltiples portadores de combustible por tarjeta.
                Para vehículos tecnológicos puedes especificar el tipo de motor (Principal o Secundario).
            </p>
        </field>
    </record>
</odoo>
