<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- IntegraciÃ³n con el menÃº de Firma Digital existente -->

    <!-- SubmenÃº para Iniciar Flujo -->
    <menuitem id="menu_iniciar_flujo"
        name="Iniciar Solicitud de Firma"
        parent="asi_pdf_signature.menu_firma_digital_root"
        action="asi_signature_workflow.action_signature_workflow_wizard"
        sequence="15" />

    <!-- SubmenÃº para Plantillas de Flujo -->
    <menuitem id="menu_plantillas_flujo"
        name="Plantillas de Flujo"
        parent="asi_pdf_signature.menu_firma_digital_root"
        action="asi_signature_workflow.action_signature_workflow_template"
        sequence="17" />

    <!-- Actualizado para flujo secuencial - Solicitudes de firma -->
    <record id="action_signature_workflow_pending" model="ir.actions.act_window">
        <field name="name">Solicitudes Pendientes de Firma</field>
        <field name="res_model">signature.workflow</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[
            ('state', '=', 'sent'),
            '|', '|', '|',
            '&amp;', ('target_user_id_1', '=', uid), ('current_recipient_index', '=', 1),
            '&amp;', ('target_user_id_2', '=', uid), ('current_recipient_index', '=', 2),
            '&amp;', ('target_user_id_3', '=', uid), ('current_recipient_index', '=', 3),
            '&amp;', ('target_user_id_4', '=', uid), ('current_recipient_index', '=', 4)
            ]</field>
        <field name="context">{'search_default_my_turn': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No tiene solicitudes pendientes de firma en este momento
            </p>
            <p>
                AquÃ­ aparecerÃ¡n las solicitudes de firma que estÃ©n esperando su firma digital.
                El flujo es secuencial, por lo que solo verÃ¡ las solicitudes cuando sea su turno.
            </p>
        </field>
    </record>

    <menuitem id="menu_flujos_pendientes"
        name="Solicitudes Pendientes"
        parent="asi_pdf_signature.menu_firma_digital_root"
        action="asi_signature_workflow.action_signature_workflow_pending"
        sequence="25" />

    <!-- SubmenÃº para Mis Flujos Creados -->
    <record id="action_signature_workflow_created" model="ir.actions.act_window">
        <field name="name">Mis Solicitudes Creadas</field>
        <field name="res_model">signature.workflow</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[('creator_id', '=', uid)]</field>
        <field name="context">{'search_default_my_created': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No ha creado ninguna solicitud de firma aÃºn
            </p>
            <p>
                AquÃ­ aparecerÃ¡n todas las solicitudes de firma que usted haya creado
                y enviado a otros usuarios para su firma.
            </p>
        </field>
    </record>

    <menuitem id="menu_mis_flujos_creados"
        name="Mis Solicitudes Creadas"
        parent="asi_pdf_signature.menu_firma_digital_root"
        action="asi_signature_workflow.action_signature_workflow_created"
        sequence="30" />

    <!-- Dashboard/Resumen de Flujos -->
    <record id="action_signature_workflow_dashboard" model="ir.actions.act_window">
        <field name="name">Dashboard de Solicitudes de Firma</field>
        <field name="res_model">signature.workflow</field>
        <field name="view_mode">kanban,tree,form</field>
        <field name="context">{
            'search_default_my_created': 1,
            'search_default_assigned_to_me': 1
            }</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Â¡Bienvenido al Dashboard de Solicitudes de Firma!
            </p>
            <p>
                Desde aquÃ­ puede ver todas sus solicitudes de firma, tanto los que ha creado
                como los que le han sido asignados para firmar.
            </p>
        </field>
    </record>

    <!-- Vista Kanban actualizada para flujo secuencial -->
    <record id="view_signature_workflow_kanban" model="ir.ui.view">
        <field name="name">signature.workflow.kanban</field>
        <field name="model">signature.workflow</field>
        <field name="arch" type="xml">
            <kanban default_group_by="state" class="o_kanban_small_column">
                <field name="name" />
                <field name="creator_id" />
                <field name="target_user_id_1" />
                <field name="current_recipient_index" />
                <field name="document_count" />
                <field name="document_source" />
                <field name="state" />
                <field name="sent_date" />
                <field name="completed_date" />
                <field name="signature_role_id_1" />
                <field name="destination_folder_id" />

                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_card oe_kanban_global_click">
                            <div class="oe_kanban_content">
                                <div class="o_kanban_record_top">
                                    <div class="o_kanban_record_headings">
                                        <strong class="o_kanban_record_title">
                                            <field name="name" />
                                        </strong>
                                    </div>
                                    <div class="o_kanban_record_top_right">
                                        <span
                                            t-att-class="'badge badge-pill ' + (record.state.raw_value == 'completed' ? 'badge-success' : record.state.raw_value == 'sent' ? 'badge-warning' : record.state.raw_value == 'moving' ? 'badge-primary' : 'badge-info')">
                                            <field name="state" />
                                        </span>
                                    </div>
                                </div>

                                <div class="o_kanban_record_body">
                                    <div class="row">
                                        <div class="col-6">
                                            <strong>Creador:</strong>
                                            <br />
                                            <field name="creator_id" />
                                        </div>
                                        <div class="col-6">
                                            <strong>Primer Destinatario:</strong>
                                            <br />
                                            <field name="target_user_id_1" />
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-6">
                                            <strong>Documentos:</strong>
                                            <field name="document_count" />
                                        </div>
                                        <div class="col-6">
                                            <strong>Origen:</strong>
                                            <span
                                                t-if="record.document_source.raw_value == 'alfresco'">ğŸ“
                                                Alfresco</span>
                                            <span t-if="record.document_source.raw_value == 'local'">ğŸ’»
                                                Local</span>
                                        </div>
                                    </div>
                                    <div class="row mt-2" t-if="record.state.raw_value == 'sent'">
                                        <div class="col-12">
                                            <strong>Turno actual:</strong> Destinatario <field
                                                name="current_recipient_index" />
                                        </div>
                                    </div>
                                    <div class="row mt-2"
                                        t-if="record.destination_folder_id.raw_value">
                                        <div class="col-12">
                                            <span class="badge badge-secondary">ğŸ“‚ Con carpeta
                                                destino</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="o_kanban_record_bottom">
                                    <div class="oe_kanban_bottom_left">
                                        <span t-if="record.sent_date.raw_value" class="text-muted">
                                            Enviado: <field name="sent_date" widget="date" />
                                        </span>
                                        <span t-if="record.completed_date.raw_value"
                                            class="text-success"> Completado: <field
                                                name="completed_date" widget="date" />
                                        </span>
                                    </div>
                                    <div class="oe_kanban_bottom_right">
                                        <button
                                            t-if="record.state.raw_value == 'sent'"
                                            name="action_sign_documents" type="object"
                                            class="btn btn-sm btn-success">
                                            ğŸ–Šï¸ Firmar
                                        </button>
                                        <button t-if="record.state.raw_value == 'completed'"
                                            name="action_download_all_signed" type="object"
                                            class="btn btn-sm btn-info">
                                            ğŸ“¥ Descargar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <menuitem id="menu_dashboard_flujos"
        name="Dashboard"
        parent="asi_pdf_signature.menu_firma_digital_root"
        action="asi_signature_workflow.action_signature_workflow_dashboard"
        sequence="9" />

    <!-- Separador visual en el menÃº -->
    <menuitem id="menu_separator_workflow"
        name="â”€â”€â”€ Solicitudes de Firma â”€â”€â”€"
        parent="asi_pdf_signature.menu_firma_digital_root"
        sequence="12" />
</odoo>