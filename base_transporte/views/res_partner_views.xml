<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Extender la vista de formulario de res.partner para choferes -->
    <record id="res_partner_view_form_driver_licenses" model="ir.ui.view">
        <field name="name">res.partner.form.driver.licenses</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_partner_form"/>
        <field name="arch" type="xml">
            
            <!-- Añadir botones en el button_box -->
            <div name="button_box" position="inside">
                <button class="oe_stat_button" type="object" name="action_view_driver_licenses" 
                        icon="fa-id-card" attrs="{'invisible': [('is_driver', '=', False)]}">
                    <field string="Licencias" name="driver_license_count" widget="statinfo"/>
                </button>
                <button class="oe_stat_button btn-success" type="object" name="action_add_driver_license" 
                        icon="fa-plus" attrs="{'invisible': [('is_driver', '=', False)]}">
                    <div class="o_field_widget o_stat_info">
                        <span class="o_stat_text">Añadir</span>
                        <span class="o_stat_text">Licencia</span>
                    </div>
                </button>
            </div>

            <!-- Añadir información de licencias en una nueva página -->
            <notebook position="inside">
                <page string="Licencias de Conducir" name="driver_licenses" attrs="{'invisible': [('is_driver', '=', False)]}">
                    
                    <!-- Alertas de licencias -->
                    <div class="alert alert-danger" role="alert" attrs="{'invisible': [('has_expired_licenses', '=', False)]}">
                        <strong>¡Atención!</strong> Este chofer tiene <field name="expired_licenses_count" readonly="1"/> licencia(s) vencida(s).
                    </div>
                    
                    <div class="alert alert-warning" role="alert" attrs="{'invisible': [('has_expiring_licenses', '=', False)]}">
                        <strong>¡Aviso!</strong> Este chofer tiene licencias que vencen pronto.
                    </div>

                    <!-- Resumen de licencias -->
                    <group string="Resumen de Licencias">
                        <group>
                            <field name="driver_license_count" readonly="1"/>
                            <field name="active_licenses_count" readonly="1"/>
                            <field name="license_types_summary" readonly="1"/>
                        </group>
                        <group>
                            <field name="expired_licenses_count" readonly="1"/>
                            <field name="has_expired_licenses" invisible="1"/>
                            <field name="has_expiring_licenses" invisible="1"/>
                            <field name="is_driver" invisible="1"/>
                        </group>
                    </group>

                    <!-- Lista de licencias -->
                    <field name="driver_license_ids" context="{'default_partner_id': active_id}">
                        <tree decoration-danger="is_expired" decoration-warning="is_expiring_soon" editable="bottom">
                            <field name="license_number"/>
                            <field name="license_type"/>
                            <field name="issue_date"/>
                            <field name="expiry_date"/>
                            <field name="days_to_expiry" readonly="1"/>
                            <field name="state" widget="badge" decoration-success="state == 'active'" 
                                   decoration-danger="state == 'expired'" decoration-warning="state == 'suspended'"/>
                            <field name="issuing_authority"/>
                            <field name="is_expired" invisible="1"/>
                            <field name="is_expiring_soon" invisible="1"/>
                        </tree>
                    </field>
                </page>
            </notebook>

        </field>
    </record>

    <!-- Extender la vista de lista de res.partner para mostrar información de choferes -->
    <record id="res_partner_view_tree_driver_info" model="ir.ui.view">
        <field name="name">res.partner.tree.driver.info</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_partner_tree"/>
        <field name="arch" type="xml">
            <field name="display_name" position="after">
                <field name="is_driver" optional="hide"/>
                <field name="driver_license_count" optional="hide"/>
                <field name="active_licenses_count" optional="hide"/>
                <field name="license_types_summary" optional="hide"/>
            </field>
        </field>
    </record>

    <!-- Extender la vista de búsqueda para filtrar choferes -->
    <record id="res_partner_view_search_driver_filters" model="ir.ui.view">
        <field name="name">res.partner.search.driver.filters</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_res_partner_filter"/>
        <field name="arch" type="xml">
            
            <!-- Añadir campo de búsqueda -->
            <field name="category_id" position="after">
                <field name="license_types_summary"/>
            </field>
            
            <!-- Añadir filtros al final de la sección de filtros -->
            <xpath expr="//search" position="inside">
                <separator/>
                <filter string="Choferes" name="drivers" domain="[('is_driver', '=', True)]"/>
                <filter string="Con Licencias Vigentes" name="active_licenses" domain="[('active_licenses_count', '>', 0)]"/>
                <filter string="Con Licencias Vencidas" name="expired_licenses" domain="[('has_expired_licenses', '=', True)]"/>
                <filter string="Con Licencias por Vencer" name="expiring_licenses" domain="[('has_expiring_licenses', '=', True)]"/>
            </xpath>

            <!-- Añadir agrupación -->
            <xpath expr="//group[@expand='0']" position="inside">
                <filter string="Tipo de Licencia" name="group_license_type" context="{'group_by': 'license_types_summary'}"/>
            </xpath>
            
        </field>
    </record>

</odoo>
